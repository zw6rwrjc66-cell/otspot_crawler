# 🔄 定时爬取功能说明

## ✅ 已实现的功能

### 1️⃣ 后端定时任务
- **位置**: `backend/main.py` 第 22-25 行
- **调度器**: APScheduler BackgroundScheduler
- **默认间隔**: 每 30 分钟自动爬取一次
- **自动启动**: 后端服务启动时自动开始
- **优雅关闭**: 服务停止时自动清理调度器

### 2️⃣ 前端可视化
- **调度器状态卡片**: 显示运行状态、抓取间隔、下次运行时间、任务数量
- **自动刷新开关**: 可开启/关闭自动刷新（默认开启，每30秒刷新一次）
- **实时状态更新**: 自动获取最新的调度器状态和热点数据
- **手动触发**: 点击"Trigger Crawl"按钮立即执行一次爬取

## 📊 前端新增功能

### 调度器状态卡片
显示内容：
- ✅ **运行状态**: 绿色标签显示"运行中"
- ⏰ **抓取间隔**: "30 minutes"
- 📅 **下次运行**: 显示具体时间（如"2025-11-24 23:17:23"）
- 📋 **任务数量**: 当前调度器中的任务数

### 自动刷新开关
- **位置**: 页面右上角，"Trigger Crawl"按钮左侧
- **功能**: 
  - 开启时：每30秒自动刷新热点数据和调度器状态
  - 关闭时：停止自动刷新，需手动点击按钮更新
- **默认状态**: 开启

## 🔧 如何修改定时间隔

### 方法1: 修改后端配置文件
编辑 `backend/main.py` 第 24 行：

```python
# 当前配置（每30分钟）
scheduler.add_job(run_crawler_task, 'interval', minutes=30)

# 修改为每15分钟
scheduler.add_job(run_crawler_task, 'interval', minutes=15)

# 修改为每1小时
scheduler.add_job(run_crawler_task, 'interval', hours=1)

# 修改为每天早上8点（使用cron）
scheduler.add_job(run_crawler_task, 'cron', hour=8, minute=0)

# 修改为每小时整点
scheduler.add_job(run_crawler_task, 'cron', minute=0)
```

修改后需要重启后端服务：
```bash
# 停止当前服务（Ctrl+C）
# 重新启动
cd /home/test/hotspot_crawler/backend
source venv/bin/activate
uvicorn main:app --host 0.0.0.0 --port 8000
```

### 方法2: 修改前端自动刷新间隔
编辑 `frontend/src/App.jsx` 第 23 行：

```javascript
// 当前配置（每30秒刷新）
const interval = setInterval(() => {
    if (autoRefresh) {
        fetchHotspots();
        fetchSchedulerStatus();
    }
}, 30000);  // 30000毫秒 = 30秒

// 修改为每10秒刷新
}, 10000);  // 10000毫秒 = 10秒

// 修改为每1分钟刷新
}, 60000);  // 60000毫秒 = 60秒
```

## 📡 API 端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/scheduler/status` | GET | 获取调度器状态 |
| `/crawl` | POST | 手动触发爬取 |
| `/hotspots` | GET | 获取热点列表 |
| `/sources` | GET | 获取数据源列表 |

### 示例：查看调度器状态
```bash
curl http://localhost:8000/scheduler/status
```

返回示例：
```json
{
    "status": "running",
    "jobs_count": 1,
    "next_run_time": "2025-11-24T23:17:23.226874+08:00",
    "interval": "30 minutes"
}
```

## 🎯 使用场景

### 场景1: 实时监控热点
- 开启自动刷新开关
- 前端每30秒自动更新数据
- 后端每30分钟自动抓取新数据
- 适合需要实时关注热点变化的场景

### 场景2: 定时查看
- 关闭自动刷新开关
- 手动点击"Trigger Crawl"按钮更新
- 后端仍然每30分钟自动抓取
- 适合偶尔查看热点的场景

### 场景3: 低频抓取
- 修改后端间隔为每6小时或每天
- 减少对目标网站的请求压力
- 节省服务器资源
- 适合不需要频繁更新的场景

## ⚠️ 注意事项

1. **请求频率**: 不建议设置过于频繁的抓取间隔（如每分钟），避免对目标网站造成压力
2. **数据存储**: 定时抓取会持续向数据库添加数据，建议定期清理旧数据
3. **服务器资源**: 自动刷新会增加前后端通信，在低配服务器上可关闭自动刷新
4. **时区问题**: 调度器使用UTC时间，前端显示时会自动转换为本地时间

## 🔍 故障排查

### 问题1: 调度器状态显示"已停止"
- 检查后端服务是否正常运行
- 查看后端日志是否有错误信息
- 重启后端服务

### 问题2: 前端不自动刷新
- 检查自动刷新开关是否开启
- 打开浏览器开发者工具查看是否有网络错误
- 检查后端API是否正常响应

### 问题3: 定时任务未执行
- 查看后端日志，确认调度器是否正常启动
- 检查 `main.py` 中的调度器配置
- 确认没有语法错误导致调度器初始化失败

## 📝 更新日志

### v1.2.0 (2025-11-24)
- ✅ 前端新增调度器状态显示卡片
- ✅ 前端新增自动刷新开关
- ✅ 后端新增调度器状态API
- ✅ 优化前端数据刷新逻辑
